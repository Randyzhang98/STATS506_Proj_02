---
title: "DL_Stata_group2"
author: "Diana Liang"
date: "12/4/2019"
output: html_document
---
## Stata
```{r setup, include=FALSE}
## Set up libraries
library(dplyr)
library(tidyr)
library(Statamarkdown)

## Set up data
sys_table <- readr::read_csv("~/2019/UMich/Fall 2019/Stats 506/Group Project/sys_table.csv")
diff_table <- readr::read_csv("~/2019/UMich/Fall 2019/Stats 506/Group Project/diff_table.csv")
```
### _Preparing the Data_
First, we loaded all the 2015 NHANES datasets into Stata. Most of the datasets only needed changes to the labels, but the systolic and diastolic blood pressures needed to be averaged for each respondent. Here is some sample code from preparing the blood pressure dataset:

```{stata, echo = TRUE, results = "hide"}
// Work with Blood Pressure dataset
/// set up data
import sasxport5 BPX_I.XPT, clear
keep seqn bpxsy1 bpxdi1 bpxsy2 bpxdi2 bpxsy3 bpxdi3
/// get rid of missing values
generate missing = 0
replace missing = 1 if bpxsy1 == . | bpxsy2 == . | bpxsy3 == . | bpxdi1 == . | bpxdi2 == . | bpxdi3 == .
keep if missing == 0
drop missing
/// find average blood pressures for each respondent
egen systolic = rowmean(bpxsy1 bpxsy2 bpxsy3)
egen diastolic = rowmean(bpxdi1 bpxdi2 bpxdi3)
keep seqn systolic diastolic
```

Once all the datasets were prepared, they were merged together by respondent, and any respondents with any missing values for our variables of interest were dropped.


### _LASSO in Stata_
Luckily, Stata has a base LASSO command that uses CV, so we only had to input the proper parameters.

#### *Response and Predictor Variables*
The easy parameters were the response variables: systolic blood pressure and the difference in blood pressures. The predictor variables, though, needed to be standardized before they could be put into the model. Here is the code to standardize by mean and standard deviation:
```{stata, echo = TRUE, results = "hide"}
foreach i in systolic diastolic fat sugar protein fiber sodium iron alcohol caff water {
	egen `i'_mean = mean(`i')
	egen `i'_std = sd(`i')
	generate `i'_s = (`i'-`i'_mean)/`i'_std
}
```

Gender was turned into a continuous variable by setting 'male' to 0.5 and 'female' to -0.5. Using this method, we can interpret a negative coefficient as the variable being more important for women than for men and vice versa.

#### *Penalty Weights*
Since we're only interested in what interaction terms are selected, we only want to use LASSO on the interaction terms while keeping the independent terms. To achieve this in code, we fully penalized (set penalty weight = 1) the interaction terms (ex. c.alcohol#c.gender) while not penalizing (set penalty weight = 0) the independent terms (ex. alcohol and gender).

Here is a visual representation. For a LASSO command line of:
```{stata, echo = TRUE, results = "hide"}
lasso linear systolic_s gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend
```
We would have a penalty weight matrix of:
````{stata, echo = TRUE, results = "hide"}
mata: wt = (0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)
```

The penalty weight of 1 is only for the interaction terms, allowing the independent terms to be included in the resulting model.

#### *Modeling*
Systolic blood pressure was modeled similar to what was shown above, and the difference was modeled in the way shown here:
```{stata, echo = TRUE, results = "hide"}
lasso linear diff gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend, penaltywt(mweight)
```

Using CV to choose the lambdas results in slightly different lambdas each time this model is run due to the nature of cross validation and the method of choosing the minimum. Keeping this in mind, we ran the models multiple times to see if the different lambdas provided dramatically different results. Since there were not dramatic differences, we continued with the analysis.

Here is the CV plot to choose lambda for the systolic model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("sys_cvplot.png")
```

And here is the CV plot to choose lambda for the difference model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("diff_cvplot.png")
```

### _Results_
Here are the resulting coefficients from the two models:

```{r, echo = FALSE}
knitr::kable(sys_table, caption = "Systolic LASSO Coefficients")
knitr::kable(diff_table, caption = "Difference LASSO Coefficients")
```

Since we're only interested in the interaction coefficients, here are the tables only including the interaction coefficients:
```{r, echo = FALSE, out.width = '50%'}
sys_interact <- sys_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(sys_interact, caption = "Systolic Gender-Interaction Coefficients")
```

We are using systolic blood pressure as a measure of both systolic and diastolic blood pressure. So, women's blood pressure is slightly more affected by caffeine; while men's blood pressure is more significantly affected by sodium and alcohol.


```{r, echo = FALSE, out.width = '50%'}
diff_interact <- diff_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(diff_interact, caption = "Difference Gender-Interaction Coefficients")
```

Difference between the blood pressures is a more accurate measure of systolic blood pressure since the only way for there to be a greater difference is if only systolic blood pressure rises without diastolic blood pressure rising. Women's blood pressure is slighly more affected by sugar but more significantly affected by caffeine and water; while men's blood pressure is more affected by alcohol and fat.

Between the two responses, women's blood pressure seems to be more affected by caffeine; and men's blood pressure more affected by alcohol. Interestingly enough, both are non-essential liquids that are gender-coded: men are more socially pressured to drink alcohol while women are more socially pressured to drink caffeine. These results may simply be due to men drinking more alcohol and women drinking more caffeine, so more surveys need to be done where these liquids are equalized between the genders.

This isn't to say that the other variables are not significant in determining blood pressure, only that the other variables affect blood pressure to a similar degree between the two genders.