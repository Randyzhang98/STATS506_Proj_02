---
title: "Stats 506: Group 2 Project"
author: "Wenjing Zhou, Sijun Zhang, Diana Liang"
output: html_document
---
# **Blood Pressure by Gender using LASSO**

# **Introduction**

With the advent of mass-produced antibiotics and the success of nation-wide inoculation campaigns, infectious diseases that were once serious threats to Americans’ health no longer dominate the leading causes of death. Instead chronic diseases; such as heart disease, cancer, and diabetes; have taken their place. Research is ongoing to pinpoint causes for these diseases, but so far the most widely-accepted explanation is lifestyle choices. Data-backed government websites and rumor-based fitness bloggers agree that what we eat and how we move greatly affects the chances of developing chronic diseases.

Yet, past research is heavily skewed towards studying the male body. Maya Dusenbery discusses in her book _Doing Harm_ how women are often disadvantaged by data that is mainly collected from men. She argues that many of the conclusions about common symptoms and reactions did not posit the possibility of important difference among genders and sexes, and assumed that the male-dominated model could represent all. While researchers are updating standards to provide more inclusive advice, we still implicitly accept that assumption in most medical situations.

The combination of rising chronic diseases and lack of diverse gender representation in research provides a unique perspective on the NHANES data. We chose to investigate the effect of consumption habits on blood pressure, a known symptom of different chronic diseases, without the assumption that all genders would react the same. Will the factors that are most important in determining blood pressure be different between males the females? We will show in the following analysis that there are certain foods that affect one gender more than the other, and that these foods change depending on the type of blood pressure being measured. (The study only provided answers of ‘male’ and ‘female’ as identifiable genders, so those will be the only ones in this analysis. Also sex and gender will be used interchangeably in this context.) 


# **Data**

We’re using a combination of 4 datasets from the 2015 NHANES.

## Datasets {.tabset .tabset-pills}

### Demographics

The demographics dataset (DEMO_I.XPT) provides us with the **gender markers** for each respondent.

### Blood Pressure

The blood pressure dataset (BPX_I.XPT) gives 4 different readings of systolic and diastolic blood pressure, and we took an average of the first three for each type of blood pressure for each respondent since the 4th is mainly missing. 

We are going to have **response variables ‘systolic’**, which will give us the generally higher or lower blood pressure, and **‘difference’** (calculated as systolic – diastolic) which will give us situations when only systolic blood pressure increases.

### Total Nutrients 

The nutrient datasets (DR1TOT_I.XPT and DR2TOT_I.XPT) provides the **predictor variables**. 

We chose the named offenders **alcohol** and **salt**; the macronutrients **total fat, sugar, and protein**; as well as **iron** to represent a meat heavy diet and **dietary fiber** to represent a vegetable heavy diet. We also included **caffeine**, which is highly contested as influencing blood pressure, and **water** as a neutral beverage.

# **Methods**

In order to find the variables that have the greatest effect(s) on blood pressure, we will use LASSO, choosing lambda by CV. 

## LASSO
LASSO, least absolute shrinkage and selector operator, works by finding the coefficients that minimize the OLS equation with a penalty term:

```{r, echo = FALSE, out.width = '30%'}
knitr::include_graphics("lasso_eq.png")
```

This equation **shrinks** all coefficients like in ridge regression but also sets coefficients below a constant to zero, effectively **selecting** variables that have more extreme coefficients.

The **lambda** in the penalty term effectively determines how extreme the model will shrink the coefficients, so finding the right lambda is important. Usually the lambda chosen is the one that minimizes the MSE from cross-validation.

## Interaction with Gender

Instead of using gender as a factor or binary variable, we will be converting gender into a continuous numerical variable by setting **‘male’ to 0.5** and **‘female’ to -0.5**. This way, the interaction coefficients can be interpreted as that variable being more important for men or women in determining blood pressure.

We’re only interested in the **interaction between the predictor variables and gender**, so we will be putting penalties only on the interaction terms and not on the independent terms. The remaining interaction coefficients,then, will be the variables that may unequally affect the blood pressure depending on gender. 

## Languages/Tools

This analysis will be done using three different techniques:

1.	R with data.table to prepare the data, and lasr to use LASSO

2.	R with dplyr to prepare, the data and glmnet to use LASSO

3.	Stata with the base code to both prepare the data and use LASSO

# **Analysis** {.tabset .tabset-pills}

## R using data.table and lars

## R using dplyr and glmnet

## Stata
```{r setup, include=FALSE}
## Set up libraries
library(dplyr)
library(tidyr)
library(Statamarkdown)

## Set up data
sys_table <- readr::read_csv("~/2019/UMich/Fall 2019/Stats 506/Group Project/sys_table.csv")
diff_table <- readr::read_csv("~/2019/UMich/Fall 2019/Stats 506/Group Project/diff_table.csv")
```
### _Preparing the Data_
First, we loaded all the 2015 NHANES datasets into Stata. Most of the datasets only needed changes to the labels, but the systolic and diastolic blood pressures needed to be averaged for each respondent. Here is some sample code from preparing the blood pressure dataset:

```{stata, echo = TRUE, results = "hide"}
// Work with Blood Pressure dataset
/// set up data
import sasxport5 BPX_I.XPT, clear
keep seqn bpxsy1 bpxdi1 bpxsy2 bpxdi2 bpxsy3 bpxdi3
/// get rid of missing values
generate missing = 0
replace missing = 1 if bpxsy1 == . | bpxsy2 == . | bpxsy3 == . | bpxdi1 == . | bpxdi2 == . | bpxdi3 == .
keep if missing == 0
drop missing
/// find average blood pressures for each respondent
egen systolic = rowmean(bpxsy1 bpxsy2 bpxsy3)
egen diastolic = rowmean(bpxdi1 bpxdi2 bpxdi3)
keep seqn systolic diastolic
```

Once all the datasets were prepared, they were merged together by respondent, and any respondents with any missing values for our variables of interest were dropped.


### _LASSO in Stata_
Luckily, Stata has a base LASSO command that uses CV, so we only had to input the proper parameters.

#### *Response and Predictor Variables*
The easy parameters were the response variables: systolic blood pressure and the difference in blood pressures. The predictor variables, though, needed to be standardized before they could be put into the model. Here is the code to standardize by mean and standard deviation:
```{stata, echo = TRUE, results = "hide"}
foreach i in systolic diastolic fat sugar protein fiber sodium iron alcohol caff water {
	egen `i'_mean = mean(`i')
	egen `i'_std = sd(`i')
	generate `i'_s = (`i'-`i'_mean)/`i'_std
}
```

Gender was turned into a continuous variable by setting 'male' to 0.5 and 'female' to -0.5. Using this method, we can interpret a negative coefficient as the variable being more important for women than for men and vice versa.

#### *Penalty Weights*
Since we're only interested in what interaction terms are selected, we only want to use LASSO on the interaction terms while keeping the independent terms. To achieve this in code, we fully penalized (set penalty weight = 1) the interaction terms (ex. c.alcohol#c.gender) while not penalizing (set penalty weight = 0) the independent terms (ex. alcohol and gender).

Here is a visual representation. For a LASSO command line of:
```{stata, echo = TRUE, results = "hide"}
lasso linear systolic_s gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend
```
We would have a penalty weight matrix of:
````{stata, echo = TRUE, results = "hide"}
mata: wt = (0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)
```

The penalty weight of 1 is only for the interaction terms, allowing the independent terms to be included in the resulting model.

#### *Modeling*
Systolic blood pressure was modeled similar to what was shown above, and the difference was modeled in the way shown here:
```{stata, echo = TRUE, results = "hide"}
lasso linear diff gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend, penaltywt(mweight)
```

Using CV to choose the lambdas results in slightly different lambdas each time this model is run due to the nature of cross validation and the method of choosing the minimum. Keeping this in mind, we ran the models multiple times to see if the different lambdas provided dramatically different results. Since there were not dramatic differences, we continued with the analysis.

Here is the CV plot to choose lambda for the systolic model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("sys_cvplot.png")
```

And here is the CV plot to choose lambda for the difference model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("diff_cvplot.png")
```

### _Results_
Here are the resulting coefficients from the two models:

```{r, echo = FALSE}
knitr::kable(sys_table, caption = "Systolic LASSO Coefficients")
knitr::kable(diff_table, caption = "Difference LASSO Coefficients")
```

Since we're only interested in the interaction coefficients, here are the tables only including the interaction coefficients:
```{r, echo = FALSE, out.width = '50%'}
sys_interact <- sys_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(sys_interact, caption = "Systolic Gender-Interaction Coefficients")
```

We are using systolic blood pressure as a measure of both systolic and diastolic blood pressure. The variables with the greatest difference between men and women are sodium, alcohol, and caffeine. So, women's blood pressure is slightly more affected by caffeine; while men's blood pressure is more significantly affected by sodium and alcohol.


```{r, echo = FALSE, out.width = '50%'}
diff_interact <- diff_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(diff_interact, caption = "Difference Gender-Interaction Coefficients")
```

Difference between the blood pressures is a more accurate measure of systolic blood pressure since the only way for there to be a greater difference is if only systolic blood pressure rises without diastolic blood pressure rising. Now the variables with the greatest difference between genders are caffeine, water, alcohol, fat, and sugar. Women's blood pressure is slighly more affected by sugar but more significantly affected by caffeine and water; while men's blood pressure is more affected by alcohol and fat.

Between the two models, the variables with the greatest difference by gender are alcohol and caffeine, though we can't say if the resulting coefficients are comparable between the models. Women's blood pressure seems to be more affected by caffeine; and men's blood pressure more affected by alcohol. Interestingly enough, both are non-essential liquids that are gender-coded: men are more socially pressured to drink alcohol while women are more socially pressured to drink caffeine. These results may simply be due to men drinking more alcohol and women drinking more caffeine, so more surveys need to be done where these liquids are equalized between the genders.

This isn't to say that the other variables are not significant in determining blood pressure, only that the other variables affect blood pressure to a more equivalent degree between the two genders. Again, LASSO shrinks all coefficients so the remaining variables are the ones that have the most extreme coefficients. Our results, then, only display the variables that have the greatest difference in effect on blood pressure between the genders.

# **Conclusion**

# **References**
Leading causes of death: https://www.cdc.gov/nchs/fastats/leading-causes-of-death.htm

Chronic diseases: https://www.cdc.gov/chronicdisease/about/prevent/index.htm 

_Doing Harm_ by Maya Dusenbery: https://www.mayadusenbery.com/book

Updating Gender Inclusivity: https://www.heart.org/en/health-topics/heart-attack/warning-signs-of-a-heart-attack/heart-attack-symptoms-in-women

Blood Pressure and Chronic Disease: https://www.mayoclinic.org/diseases-conditions/high-blood-pressure/in-depth/blood-pressure/art-20050982 and https://www.mayoclinic.org/diseases-conditions/high-blood-pressure/symptoms-causes/syc-20373410

LASSO: Faraway, Julian James. Linear Models with R. CRC Press LLC, 2009.
