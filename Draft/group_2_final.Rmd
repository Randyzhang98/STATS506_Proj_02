---
title: "Stats 506: Group 2 Project"
author: "Wenjing Zhou, Sijun Zhang, Diana Liang"
output: html_document
---
# **Blood Pressure by Gender using LASSO**

# **Introduction**

With the advent of mass-produced antibiotics and the success of nation-wide inoculation campaigns, infectious diseases that were once serious threats to Americans’ health no longer dominate the leading causes of death. Instead chronic diseases; such as heart disease, cancer, and diabetes; have taken their place. Research is ongoing to pinpoint causes for these diseases, but so far the most widely-accepted explanation is lifestyle choices. Data-backed government websites and rumor-based fitness bloggers agree that what we eat and how we move greatly affects the chances of developing chronic diseases.

Yet, past research is heavily skewed towards studying the male body. Maya Dusenbery discusses in her book _Doing Harm_ how women are often disadvantaged by data that is mainly collected from men. She argues that many of the conclusions about common symptoms and reactions did not posit the possibility of important difference among genders and sexes, and assumed that the male-dominated model could represent all. While researchers are updating standards to provide more inclusive advice, we still implicitly accept that assumption in most medical situations.

The combination of rising chronic diseases and lack of diverse gender representation in research provides a unique perspective on the NHANES data. We chose to investigate the effect of consumption habits on blood pressure, a known symptom of different chronic diseases, without the assumption that all genders would react the same. Will the factors that are most important in determining blood pressure be different between males the females? We will show in the following analysis that there are certain foods that affect one gender more than the other, and that these foods change depending on the type of blood pressure being measured. (The study only provided answers of ‘male’ and ‘female’ as identifiable genders, so those will be the only ones in this analysis. Also sex and gender will be used interchangeably in this context.) 


# **Data**

We’re using a combination of 4 datasets from the 2015 NHANES.

## Datasets {.tabset .tabset-pills}

### Demographics

The demographics dataset (DEMO_I.XPT) provides us with the **gender markers** for each respondent.

### Blood Pressure

The blood pressure dataset (BPX_I.XPT) gives 4 different readings of systolic and diastolic blood pressure, and we took an average of the first three for each type of blood pressure for each respondent since the 4th is mainly missing. 

We are going to have **response variables ‘systolic’**, which will give us the generally higher or lower blood pressure, and **‘difference’** (calculated as systolic – diastolic) which will give us situations when only systolic blood pressure increases.

### Total Nutrients 

The nutrient datasets (DR1TOT_I.XPT and DR2TOT_I.XPT) provides the **predictor variables**. 

We chose the named offenders **alcohol** and **salt**; the macronutrients **total fat, sugar, and protein**; as well as **iron** to represent a meat heavy diet and **dietary fiber** to represent a vegetable heavy diet. We also included **caffeine**, which is highly contested as influencing blood pressure, and **water** as a neutral beverage.

# **Methods**

In order to find the variables that have the greatest effect(s) on blood pressure, we will use LASSO, choosing lambda by CV. 

## LASSO
LASSO, least absolute shrinkage and selector operator, works by finding the coefficients that minimize the OLS equation with a penalty term:

$$
\min _{\beta \in \mathbb{R}^{p}}\left\{\frac{1}{N}\|y-X \beta\|_{2}^{2}+\lambda\|\beta\|_{1}\right\}
$$
This equation **shrinks** all coefficients like in ridge regression but also sets coefficients below a constant to zero, effectively **selecting** variables that have more extreme coefficients.

The **lambda** in the penalty term effectively determines how extreme the model will shrink the coefficients, so finding the right lambda is important. Usually the lambda chosen is the one that minimizes the MSE from cross-validation.

## Interaction with Gender

Instead of using gender as a factor or binary variable, we will be converting gender into a continuous numerical variable by setting **‘male’ to 0.5** and **‘female’ to -0.5**. This way, the interaction coefficients can be interpreted as that variable being more important for men or women in determining blood pressure.

We’re only interested in the **interaction between the predictor variables and gender**, so we will be putting penalties only on the interaction terms and not on the independent terms. The remaining interaction coefficients,then, will be the variables that may unequally affect the blood pressure depending on gender. 

## Languages/Tools

This analysis will be done using three different techniques:

1.	R with data.table to prepare the data, and lasr to use LASSO

2.	R with dplyr to prepare, the data and glmnet to use LASSO

3.	Stata with the base code to both prepare the data and use LASSO

# **Analysis** {.tabset .tabset-pills}

## R using data.table and lars

## R using dplyr and glmnet

### Perparing Data

First we will import all 2015-2016 NHANES and check if the data is perpared in the common data folder. If not, we will download the data from the website. Here is a sample importing process

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(Hmisc)
library(SASxport)
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# read in the  data: -----------------------------------------------------------
## This data will be used in the question. 
url_base <- 'https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/'

demo_file <- '../DATA/DEMO_I.XPT'
if ( !file.exists(demo_file) ) {
  demo_url <- sprintf('%s/DEMO_I.XPT', url_base)
  demo <- sasxport.get(demo_url)
  write.xport(demo, file = demo_file)
} else {
  demo <- sasxport.get(demo_file)
}

```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
dr1_file <- '../DATA/DR1TOT_I.XPT'
if ( !file.exists(dr1_file) ) {
  dr1_url <- sprintf('%s/DR1TOT_I.XPT', url_base)
  dr1 <- sasxport.get(dr1_url)
  write.xport(dr1, file = dr1_file)
} else {
  dr1 <- sasxport.get(dr1_file)
}

dr2_file <- '../DATA/DR2TOT_I.XPT'
if ( !file.exists(demo_file) ) {
  dr2_url <- sprintf('%s/DR2TOT_I.XPT', url_base)
  dr2 <- sasxport.get(dr2_url)
  write.xport(dr2, file = dr2_file)
} else {
  dr2 <- sasxport.get(dr2_file)
}

bpx_file <- '../DATA/BPX_I.XPT'
if ( !file.exists(bpx_file) ) {
  bpx_url <- sprintf('%s/BPX_I.XPT', url_base)
  bpx <- sasxport.get(bpx_url)
  write.xport(bpx, file = bpx_file)
} else {
  bpx <- sasxport.get(bpx_file)
}
```



Then we select only the responents with both two day data collected with no missing value and then take average of them as the average nutrition intake.

Meanwhile, we also standarized the predictors and then merge the data together. We take the systolic and diastolic blood pressures as the responses that are needed to be averaged for each respondent. 

The gender variable are also assigned to -0.5(male) and 0.5(female) to make the expectation of them equal to zero. 

```{r}
dr1 = dr1 %>%
  transmute(seqn = seqn, alco = as.numeric(dr1talco),
            water = as.numeric(dr1.320z), caff = as.numeric(dr1tcaff),
            sodi = as.numeric(dr1tsodi), fat = as.numeric(dr1ttfat), 
            sugr = as.numeric(dr1tsugr), iron = as.numeric(dr1tiron),
            fibe = as.numeric(dr1tfibe), prot = as.numeric(dr1tprot) ) %>%
  gather(key = "meas", value = "day1", -seqn )

dr2 = dr2 %>%
  transmute(seqn = seqn, alco = as.numeric(dr2talco),
            water = as.numeric(dr2.320z), caff = as.numeric(dr2tcaff), 
            sodi = as.numeric(dr2tsodi), fat = as.numeric(dr2ttfat), 
            sugr = as.numeric(dr2tsugr), iron = as.numeric(dr2tiron),
            fibe = as.numeric(dr2tfibe), prot = as.numeric(dr2tprot) ) %>%
  gather(key = "meas", value = "day2", -seqn )

dr = dr1 %>%
  left_join(dr2, by = c('seqn', 'meas'))  %>%
  gather(key = "svy_day", value = "value", day1:day2) %>%
  spread(key = "meas", value = "value" ) %>%
  group_by(seqn) %>%
  summarise(alco = mean(alco), caff = mean(caff),
            fat = mean(fat), fibe = mean(fibe),
            iron = mean(iron), prot = mean(prot),
            sodi = mean(sodi), sugr = mean(sugr), water = mean(water))

demo = demo %>%
  # transmute(seqn = seqn, age = ridageyr, pir = indfmpir, gender = riagendr)
  transmute(seqn = seqn, gender = riagendr)

bpx = bpx %>%
  # most people havn't test 4 so we just ignore it
  transmute(seqn = seqn, bpxsy_avg = (bpxsy1+bpxsy2+bpxsy3)/3,
            bpxdiff_avg = ((bpxsy1-bpxdi1)+(bpxsy2-bpxdi2)+(bpxsy3-bpxdi3))/3)

bpx_dr = dr %>%
  left_join(bpx, by="seqn")


df = bpx_dr %>%
  left_join(demo, by = "seqn") %>%
  drop_na()

# standardizing process
df_scale = scale(df[,2:10])

df = df %>%
  select(seqn, bpxsy_avg, bpxdiff_avg, gender) %>%
  transmute(seqn, bpxsy_avg, bpxdiff_avg, gender = gender-1.5) %>%
  cbind(df_scale) %>%
  mutate(gender_alco = gender*alco,
         gender_caff = gender*caff,
         gender_fat = gender*fat,
         gender_fibe = gender*fibe,
         gender_iron = gender*iron,
         gender_prot = gender*prot,
         gender_sodi = gender*sodi,
         gender_sugr = gender*sugr,
         gender_water = water*gender)
```

Then, in order to compare the different data analysis tools, the lasso analysis will be done in the Python

```{r}
write.csv(df, file = "group_2_df.csv", row.names = FALSE)
```

### LASSO in glmnet

#### Penalty.factor

Since our purpose is to find how gender effect the relationship between the nutrition intake and the blood pressure measurement, we only penalize the interaction terms by setting the penalty.factor of the interaction terms with a same positive value and let other terms' zero. The explict form for LASSO minizing goal is shaped to 

$$
\underset{\beta}{\operatorname{minimize}} \quad \frac{1}{2} \frac{\operatorname{RSS}}{n}+\lambda \sum_{j=1}^{p} \frac{c_{j}}{\bar{c}}\left\|\beta_{j}\right\|_{1}
$$

where $c_j$ is the penalty factor we used for each term

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library("glmnet")
```


#### Cross-validation 

Before we fit the LASSO model for each response, we should first obtain appropriate $\lambda$ to control the L1 punishment on the interaction terms.

```{r}
library("glmnet")
# for bpxsy as response 
set.seed(1984)
penalty.factor = append(rep(0,10),rep(1, 9))

# The cross-validation using 20 folded training-test set.
mod_cv1 <- cv.glmnet(x=as.matrix(df[,c(4:22)]), y=as.matrix(df[,c(2)]), nfolds = 20, 
                     type.measure = "mse", family='gaussian', parallel = TRUE, penalty.factor = penalty.factor)


min_lambda1 = mod_cv1$lambda.min

plot(mod_cv1$lambda, mod_cv1$cvm, ylab = "Mean standard error", xlab = "lambda",
     main = "Cross-validation for lambda in systolic pressure")
abline(v = mod_cv1$lambda.min)

# for bpxdiff as response 
set.seed(1984)

# The cross-validation using 20 folded training-test set.
mod_cv2 <- cv.glmnet(x=as.matrix(df[,c(4:22)]), y=as.matrix(df[,c(3)]), nfolds = 20, 
                     type.measure = "mse", family='gaussian', parallel = TRUE, penalty.factor = penalty.factor)

min_lambda2 = mod_cv2$lambda.min

plot(mod_cv2$lambda, mod_cv2$cvm, ylab = "Mean standard error", xlab = "lambda",
     main = "Cross-validation for lambda in pressure difference")
abline(v = mod_cv2$lambda.min)

```

As we can find in the figures, as the curve of MSE versus $\lambda$ is not convex, thus different folder selection may result in different $\lambda$ selection. In this point, I select the case that $\lambda_{min}$ is not at the edge condition and set as the parameters for LASSO fitting.

#### LASSO Modeling

```{r}
m1 = glmnet(x = as.matrix(df[,c(4:22)]), 
            y = as.matrix(df[,c(2)]), lambda = min_lambda1,
            family="gaussian", alpha = 1, penalty.factor = penalty.factor, nlambda = 100)

m2= glmnet(x = as.matrix(df[,c(4:22)]), 
            y = as.matrix(df[,c(3)]), lambda = min_lambda2,
            family="gaussian", alpha = 1, penalty.factor = penalty.factor, nlambda = 100)

# data collection
coef1 = coef(m1)
coef2 = coef(m2)
coef = cbind(coef1, coef2)
lambda = cbind(min_lambda1, min_lambda2)
rownames(lambda) = "lambda_min_mse"
coef = rbind(coef, lambda)
colnames(coef) = c("systolic", "difference")

coef
```

#### Result

As we are only interested on the interaction terms with non-zero coefficients. The interacted terms for systolic pressure and pressure difference are shown in the following table.

For systolic pressure:

```{r echo=FALSE}
coef[c(12,13,18),1] 
```

From the result, we can obtain that comparing to men, women's systolic blood pressure is more likely to be lifted by the increasement of caffeine intaking. However, the increasement of sodium and alcohol intaking will affect more on men's systolic blood pressure.  

For blood pressure difference
```{r echo=FALSE}
coef[c(12,13,14,18,20),2] 
```

As the above table shows, we can obtain that comparing to men, women's blood pressure differnece is more likely to be lifted by the increasement of caffeine and water intaking. However, the increasement of sodium, fat and alcohol intaking will affect more on men's systolic blood pressure.  

In the blood pressure difference result, we can find the interaction term with water is as large as the caffeine term, which might imply that the correlation between the water and caffeine variable. 

Across these two responses, women’s blood pressure seems to be more affected by caffeine; and men’s blood pressure more affected by alcohol. However, the result doesn't imply that the women has a high intake of caffine. Indeed, the caffeine intake of women is less than men (-0.5(male), 0.5(female)). The reasonable interpretation of this result is that women's blood pressure is more sensitive to the caffeine and men's is more sensitive to the alcohol. As the blood pressure may influnce the one's judgement and endurance, the result may imply that women have a better drinking capacity than men.


```{r}
df %>% filter(gender == 0.5) %>% summarise(caff_avg_intake_women = mean(caff))
df %>% filter(gender == -0.5) %>% summarise(caff_avg_intake_men = mean(caff))
```




## Stata
```{r setup, include=FALSE}
## Set up libraries
library(dplyr)
library(tidyr)
library(Statamarkdown)

## Set up data
sys_table <- readr::read_csv("sys_table.csv")
diff_table <- readr::read_csv("diff_table.csv")
```
### _Preparing the Data_
First, we loaded all the 2015 NHANES datasets into Stata. Most of the datasets only needed changes to the labels, but the systolic and diastolic blood pressures needed to be averaged for each respondent. Here is some sample code from preparing the blood pressure dataset:

```{stata, echo = TRUE, results = "hide"}
// Work with Blood Pressure dataset
/// set up data
import sasxport5 BPX_I.XPT, clear
keep seqn bpxsy1 bpxdi1 bpxsy2 bpxdi2 bpxsy3 bpxdi3
/// get rid of missing values
generate missing = 0
replace missing = 1 if bpxsy1 == . | bpxsy2 == . | bpxsy3 == . | bpxdi1 == . | bpxdi2 == . | bpxdi3 == .
keep if missing == 0
drop missing
/// find average blood pressures for each respondent
egen systolic = rowmean(bpxsy1 bpxsy2 bpxsy3)
egen diastolic = rowmean(bpxdi1 bpxdi2 bpxdi3)
keep seqn systolic diastolic
```

Once all the datasets were prepared, they were merged together by respondent, and any respondents with any missing values for our variables of interest were dropped.


### _LASSO in Stata_
Luckily, Stata has a base LASSO command that uses CV, so we only had to input the proper parameters.

#### *Response and Predictor Variables*
The easy parameters were the response variables: systolic blood pressure and the difference in blood pressures. The predictor variables, though, needed to be standardized before they could be put into the model. Here is the code to standardize by mean and standard deviation:
```{stata, echo = TRUE, results = "hide"}
foreach i in systolic diastolic fat sugar protein fiber sodium iron alcohol caff water {
	egen `i'_mean = mean(`i')
	egen `i'_std = sd(`i')
	generate `i'_s = (`i'-`i'_mean)/`i'_std
}
```

Gender was turned into a continuous variable by setting 'male' to 0.5 and 'female' to -0.5. Using this method, we can interpret a negative coefficient as the variable being more important for women than for men and vice versa.

#### *Penalty Weights*
Since we're only interested in what interaction terms are selected, we only want to use LASSO on the interaction terms while keeping the independent terms. To achieve this in code, we fully penalized (set penalty weight = 1) the interaction terms (ex. c.alcohol#c.gender) while not penalizing (set penalty weight = 0) the independent terms (ex. alcohol and gender).

Here is a visual representation. For a LASSO command line of:
```{stata, echo = TRUE, results = "hide"}
lasso linear systolic_s gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend
```
We would have a penalty weight matrix of:
````{stata, echo = TRUE, results = "hide"}
mata: wt = (0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1)
```

The penalty weight of 1 is only for the interaction terms, allowing the independent terms to be included in the resulting model.

#### *Modeling*
Systolic blood pressure was modeled similar to what was shown above, and the difference was modeled in the way shown here:
```{stata, echo = TRUE, results = "hide"}
lasso linear diff gend fat_s c.fat_s#c.gend sugar_s c.sugar_s#c.gend protein_s c.protein_s#c.gend fiber_s c.fiber_s#c.gend sodium_s c.sodium_s#c.gend iron_s c.iron_s#c.gend alcohol_s c.alcohol_s#c.gend caff_s c.caff_s#c.gend water_s c.water_s#c.gend, penaltywt(mweight)
```

Using CV to choose the lambdas results in slightly different lambdas each time this model is run due to the nature of cross validation and the method of choosing the minimum. Keeping this in mind, we ran the models multiple times to see if the different lambdas provided dramatically different results. Since there were not dramatic differences, we continued with the analysis.

Here is the CV plot to choose lambda for the systolic model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("sys_cvplot.png")
```

And here is the CV plot to choose lambda for the difference model:

```{r, echo = FALSE, out.width = '50%'}
knitr::include_graphics("diff_cvplot.png")
```

### _Results_
Here are the resulting coefficients from the two models:

```{r, echo = FALSE}
knitr::kable(sys_table, caption = "Systolic LASSO Coefficients")
knitr::kable(diff_table, caption = "Difference LASSO Coefficients")
```

Since we're only interested in the interaction coefficients, here are the tables only including the interaction coefficients:
```{r, echo = FALSE, out.width = '50%'}
sys_interact <- sys_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(sys_interact, caption = "Systolic Gender-Interaction Coefficients")
```

We are using systolic blood pressure as a measure of both systolic and diastolic blood pressure. So, women's blood pressure is slightly more affected by caffeine; while men's blood pressure is more significantly affected by sodium and alcohol.


```{r, echo = FALSE, out.width = '50%'}
diff_interact <- diff_table %>%
  filter(grepl('#', Variables)) %>%
  arrange(Coefficients)
knitr::kable(diff_interact, caption = "Difference Gender-Interaction Coefficients")
```

Difference between the blood pressures is a more accurate measure of systolic blood pressure since the only way for there to be a greater difference is if only systolic blood pressure rises without diastolic blood pressure rising. Women's blood pressure is slighly more affected by sugar but more significantly affected by caffeine and water; while men's blood pressure is more affected by alcohol and fat.

Between the two responses, women's blood pressure seems to be more affected by caffeine; and men's blood pressure more affected by alcohol. Interestingly enough, both are non-essential liquids that are gender-coded: men are more socially pressured to drink alcohol while women are more socially pressured to drink caffeine. These results may simply be due to men drinking more alcohol and women drinking more caffeine, so more surveys need to be done where these liquids are equalized between the genders.

This isn't to say that the other variables are not significant in determining blood pressure, only that the other variables affect blood pressure to a similar degree between the two genders.

# **Conclusion and Disscussion**

Overall, 

# **References**
Leading causes of death: https://www.cdc.gov/nchs/fastats/leading-causes-of-death.htm

Chronic diseases: https://www.cdc.gov/chronicdisease/about/prevent/index.htm 

_Doing Harm_ by Maya Dusenbery: https://www.mayadusenbery.com/book

Updating Gender Inclusivity: https://www.heart.org/en/health-topics/heart-attack/warning-signs-of-a-heart-attack/heart-attack-symptoms-in-women

Blood Pressure and Chronic Disease: https://www.mayoclinic.org/diseases-conditions/high-blood-pressure/in-depth/blood-pressure/art-20050982 and https://www.mayoclinic.org/diseases-conditions/high-blood-pressure/symptoms-causes/syc-20373410

LASSO: Faraway, Julian James. Linear Models with R. CRC Press LLC, 2009.
